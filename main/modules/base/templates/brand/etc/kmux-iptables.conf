# $Id: kmux-iptables.conf 2571 2014-12-07 14:49:59Z julianthome $
#

# this is the <empty>-version of kmux-iptables.conf (see kmux.config: KMUX_CONFIG_NETWORK_TYPE)
# there ist also a customer-version

# Attention: these tables use DNS-names (because we need rules for the
# 	     extern (DSL) interface)
# 	     therefore iptables must be started AFTER the local bind, otherwise they fail
# better:    disable the DNS-based rules if the names can't be resolved
#            HOW?

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# von extern nur SSH zum speziellen ssh-port (wegen der vserver und dynamischer IPs)
-A INPUT -p tcp --dport KMUX_SSHD_PORT -j ACCEPT
-A INPUT -m state  --state RELATED,ESTABLISHED -j ACCEPT

# OpenVPN
# von extern kommender Verbindungsaufbau
-A INPUT -i KMUX_EXTERN_INTERFACE -p udp --dport 1194 -j ACCEPT

# Asterisk
# siehe PREROUTING

# vom Tunnel darf man ï¿½berall hin
-A INPUT -i tun0 -j ACCEPT
-A FORWARD -i tun0 -j ACCEPT

-A INPUT -i lxcbr0 -j ACCEPT
-A FORWARD -i lxcbr0 -j ACCEPT

# vom internen Netz zum Service-Netz (actually not need)
#-A FORWARD -i KMUX_INTERN_INTERFACE -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j ACCEPT

# Fragmentierte Pakete werden verworfen
-A INPUT -f -j DROP

# vom internen Netz alles erlaubt zu lokalen Prozessen
# Ausnahme: OpenVPN 
-A INPUT -i KMUX_INTERN_INTERFACE -j ACCEPT

# vom loopback-Interface alles erlaubt zu lokalen Prozessen
-A INPUT -i lo -j ACCEPT

# all the rest is routed to extern world (except OpenVPN)
-A FORWARD -i KMUX_INTERN_INTERFACE -p tcp ! --dport 1194 -j ACCEPT
-A FORWARD -i KMUX_INTERN_INTERFACE -p udp ! --dport 1194 -j ACCEPT

# WebMail
-A FORWARD -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 443 -d KMUX_DUMMY_MAIL_IP -j ACCEPT
-A FORWARD -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 80 -d KMUX_DUMMY_MAIL_IP -j ACCEPT

-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

COMMIT

# sollen ports (also besonders www auf port 80 wegen dem squid-proxy) auf dem 
# kmux-host erreicht werden durch einen lokalen Prozess, so ist immer zur der
# allgemeinen PREROUTING chain ein Eintrag in der OUTPUT chain erforderlich.

*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]


# transparent web proxy
# all local traffic except from the squid-proxy itself redirect to proxy
# no proxy for user-root (needed for installation: 
# if we redirect the root-originated traffic, the installation stops for unknown reason ...)
#-A OUTPUT -p tcp -m owner ! --uid-owner proxy -m owner ! --uid-owner root --dport 80 -j REDIRECT --to-port 3128
# sind in den sources.list file die Quellen NICHT mehrfach vorhanden, so geht es dann ...
-A OUTPUT -p tcp -m owner ! --uid-owner proxy  --dport 80 -j REDIRECT --to-port 3128

# all traffic from internal to external web
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_NETIP/KMUX_INTERN_NETMASK_BITS --dport 80 -j REDIRECT --to-port 3128
-A PREROUTING -i KMUX_VPN_INTERFACE -p tcp ! -d KMUX_INTERN_NETIP/KMUX_INTERN_NETMASK_BITS --dport 80 -j REDIRECT --to-port 3128

# ftp proxy
# all ftp traffic from internal to external ftp through ftp-proxy
#-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_MAIL_IP --dport 21 -j REDIRECT --to-port 2121
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_MAIL_IP --dport 21 -j ACCEPT

# ntp redirect to local ntp-server
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_HOST_IP --dport 123 -j DNAT --to-destination KMUX_INTERN_HOST_IP
-A PREROUTING -i KMUX_INTERN_INTERFACE -p udp ! -d KMUX_INTERN_HOST_IP --dport 123 -j DNAT --to-destination KMUX_INTERN_HOST_IP

# dns redirect to local dns-server
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_HOST_IP --dport 53 -j DNAT --to-destination KMUX_INTERN_HOST_IP
-A PREROUTING -i KMUX_INTERN_INTERFACE -p udp ! -d KMUX_INTERN_HOST_IP --dport 53 -j DNAT --to-destination KMUX_INTERN_HOST_IP

# output rules to route to SNAT from the vservers to the intern network

-A POSTROUTING -s KMUX_DUMMY_SVC_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SVC_IP
-A POSTROUTING -s KMUX_DUMMY_FS_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FS_IP

# iptables testing (uses monit service itself)
# geht so nicht???
#-A OUTPUT -d KMUX_INTERN_HOST_IP -p tcp --dport 2814 -j REDIRECT --to-port 2813 

-A POSTROUTING -o KMUX_EXTERN_INTERFACE -j MASQUERADE 

COMMIT
