# $Id: kmux-iptables.conf 2571 2014-12-07 14:49:59Z julianthome $
#

# this is the <empty>-version of kmux-iptables.conf (see kmux.config: KMUX_CONFIG_NETWORK_TYPE)
# there ist also a customer-version

# Attention: these tables use DNS-names (because we need rules for the
# 	     extern (DSL) interface)
# 	     therefore iptables must be started AFTER the local bind, otherwise they fail
# better:    disable the DNS-based rules if the names can't be resolved
#            HOW?

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# von extern nur SSH zum speziellen ssh-port (wegen der vserver und dynamischer IPs)
-A INPUT -p tcp --dport KMUX_SSHD_PORT -j ACCEPT
-A INPUT -m state  --state RELATED,ESTABLISHED -j ACCEPT

# OpenVPN
# von extern kommender Verbindungsaufbau
-A INPUT -i KMUX_EXTERN_INTERFACE -p udp --dport 1194 -j ACCEPT

# Asterisk
# siehe PREROUTING

# vom Tunnel darf man ï¿½berall hin
-A INPUT -i tun0 -j ACCEPT
-A FORWARD -i tun0 -j ACCEPT

-A INPUT -i lxcbr0 -j ACCEPT
-A FORWARD -i lxcbr0 -j ACCEPT

# vom internen Netz zum Service-Netz (actually not need)
#-A FORWARD -i KMUX_INTERN_INTERFACE -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j ACCEPT

# Fragmentierte Pakete werden verworfen
-A INPUT -f -j DROP

# vom internen Netz alles erlaubt zu lokalen Prozessen
# Ausnahme: OpenVPN 
-A INPUT -i KMUX_INTERN_INTERFACE -j ACCEPT

# VoIP (Asterisk) Intern
-A INPUT -i KMUX_VOIP_INTERFACE -j ACCEPT 
-A FORWARD -i KMUX_VOIP_INTERFACE -j ACCEPT
# vom loopback-Interface alles erlaubt zu lokalen Prozessen
-A INPUT -i lo -j ACCEPT


# OpenVPN (but not to our own vpn)
# here we use DNS-Name - this may prevent the iptables rules to be fully loaded
# this rule can be omitted, if no ovpn connection must be opened to extern
# this is the usual case, only service-provider want to log into remote kmux-systems
#-A FORWARD -i KMUX_INTERN_INTERFACE -p udp --dport 1194 ! -d KMUX_VPN_EXTERN -j ACCEPT

# all the rest is routed to extern world 
#-A FORWARD -i KMUX_INTERN_INTERFACE -p tcp -j ACCEPT
#-A FORWARD -i KMUX_INTERN_INTERFACE -p udp -j ACCEPT
# all the rest is routed to extern world (except OpenVPN)
-A FORWARD -i KMUX_INTERN_INTERFACE -p tcp ! --dport 1194 -j ACCEPT
-A FORWARD -i KMUX_INTERN_INTERFACE -p udp ! --dport 1194 -j ACCEPT

# WebMail
-A FORWARD -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 443 -d KMUX_DUMMY_MAIL_IP -j ACCEPT
-A FORWARD -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 80 -d KMUX_DUMMY_MAIL_IP -j ACCEPT

-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT

COMMIT

# sollen ports (also besonders www auf port 80 wegen dem squid-proxy) auf dem 
# kmux-host erreicht werden durch einen lokalen Prozess, so ist immer zur der
# allgemeinen PREROUTING chain ein Eintrag in der OUTPUT chain erforderlich.

*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# input rules to reach the vservers from the intern network (DNAT)
# each vserver needs a output-rule (local process) to reach other vserver

# custom vserver
-A PREROUTING -d KMUX_INTERN_CUSTOM_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_CUSTOM_IP 
-A PREROUTING -d KMUX_INTERN_CUSTOM_IP -p udp -j DNAT --to-destination KMUX_DUMMY_CUSTOM_IP 
-A OUTPUT -d KMUX_INTERN_CUSTOM_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_CUSTOM_IP 
-A OUTPUT -d KMUX_INTERN_CUSTOM_IP -p udp -j DNAT --to-destination KMUX_DUMMY_CUSTOM_IP 

# agfeo vserver
-A PREROUTING -d KMUX_INTERN_AGFEO_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_AGFEO_IP 
-A PREROUTING -d KMUX_INTERN_AGFEO_IP -p udp -j DNAT --to-destination KMUX_DUMMY_AGFEO_IP 
-A OUTPUT -d KMUX_INTERN_AGFEO_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_AGFEO_IP 
-A OUTPUT -d KMUX_INTERN_AGFEO_IP -p udp -j DNAT --to-destination KMUX_DUMMY_AGFEO_IP 

# sugar vserver
-A PREROUTING -d KMUX_INTERN_SUGAR_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_SUGAR_IP 
-A PREROUTING -d KMUX_INTERN_SUGAR_IP -p udp -j DNAT --to-destination KMUX_DUMMY_SUGAR_IP 
-A OUTPUT -d KMUX_INTERN_SUGAR_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_SUGAR_IP 
-A OUTPUT -d KMUX_INTERN_SUGAR_IP -p udp -j DNAT --to-destination KMUX_DUMMY_SUGAR_IP 

# zpub vserver
-A PREROUTING -d KMUX_INTERN_ZPUB_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_ZPUB_IP 
-A PREROUTING -d KMUX_INTERN_ZPUB_IP -p udp -j DNAT --to-destination KMUX_DUMMY_ZPUB_IP 
-A OUTPUT -d KMUX_INTERN_ZPUB_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ZPUB_IP 
-A OUTPUT -d KMUX_INTERN_ZPUB_IP -p udp -j DNAT --to-destination KMUX_DUMMY_ZPUB_IP 

# wordpress vserver
-A PREROUTING -d KMUX_INTERN_WORDPRESS_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_WORDPRESS_IP 
-A PREROUTING -d KMUX_INTERN_WORDPRESS_IP -p udp -j DNAT --to-destination KMUX_DUMMY_WORDPRESS_IP 
-A OUTPUT -d KMUX_INTERN_WORDPRESS_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_WORDPRESS_IP 
-A OUTPUT -d KMUX_INTERN_WORDPRESS_IP -p udp -j DNAT --to-destination KMUX_DUMMY_WORDPRESS_IP 

# find vserver
-A PREROUTING -d KMUX_INTERN_FIND_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_FIND_IP 
-A PREROUTING -d KMUX_INTERN_FIND_IP -p udp -j DNAT --to-destination KMUX_DUMMY_FIND_IP 
-A OUTPUT -d KMUX_INTERN_FIND_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_FIND_IP 
-A OUTPUT -d KMUX_INTERN_FIND_IP -p udp -j DNAT --to-destination KMUX_DUMMY_FIND_IP 

# imixs vserver
-A PREROUTING -d KMUX_INTERN_IMIXS_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_IMIXS_IP 
-A PREROUTING -d KMUX_INTERN_IMIXS_IP -p udp -j DNAT --to-destination KMUX_DUMMY_IMIXS_IP 
-A OUTPUT -d KMUX_INTERN_IMIXS_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_IMIXS_IP 
-A OUTPUT -d KMUX_INTERN_IMIXS_IP -p udp -j DNAT --to-destination KMUX_DUMMY_IMIXS_IP 

# redmine vserver
-A PREROUTING -d KMUX_INTERN_REDMINE_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_REDMINE_IP 
-A PREROUTING -d KMUX_INTERN_REDMINE_IP -p udp -j DNAT --to-destination KMUX_DUMMY_REDMINE_IP 
-A OUTPUT -d KMUX_INTERN_REDMINE_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_REDMINE_IP 
-A OUTPUT -d KMUX_INTERN_REDMINE_IP -p udp -j DNAT --to-destination KMUX_DUMMY_REDMINE_IP 

# zarafa vserver
-A PREROUTING -d KMUX_INTERN_ZARAFA_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_ZARAFA_IP 
-A PREROUTING -d KMUX_INTERN_ZARAFA_IP -p udp -j DNAT --to-destination KMUX_DUMMY_ZARAFA_IP 
-A OUTPUT -d KMUX_INTERN_ZARAFA_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ZARAFA_IP 
-A OUTPUT -d KMUX_INTERN_ZARAFA_IP -p udp -j DNAT --to-destination KMUX_DUMMY_ZARAFA_IP 

# friendica vserver
-A PREROUTING -d KMUX_INTERN_FRIENDICA_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_FRIENDICA_IP
-A PREROUTING -d KMUX_INTERN_FRIENDICA_IP -p udp -j DNAT --to-destination KMUX_DUMMY_FRIENDICA_IP
-A OUTPUT -d KMUX_INTERN_FRIENDICA_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_FRIENDICA_IP
-A OUTPUT -d KMUX_INTERN_FRIENDICA_IP -p udp -j DNAT --to-destination KMUX_DUMMY_FRIENDICA_IP

# mail
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 143 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 25 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 465 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 587 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 21 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 2000 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 60000:60999 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -d KMUX_INTERN_MAIL_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A PREROUTING -i KMUX_EXTERN_INTERFACE -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_MAIL_IP 
-A OUTPUT -d KMUX_INTERN_MAIL_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_MAIL_IP

# ldap
-A PREROUTING -d KMUX_INTERN_LDAP_IP -p tcp -m tcp --dport 389 -j DNAT --to-destination KMUX_DUMMY_LDAP_IP
-A PREROUTING -d KMUX_INTERN_LDAP_IP -p tcp -m tcp --dport 636 -j DNAT --to-destination KMUX_DUMMY_LDAP_IP
-A PREROUTING -d KMUX_INTERN_LDAP_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_LDAP_IP 
-A OUTPUT -d KMUX_INTERN_LDAP_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_LDAP_IP 

# svc
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 22 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 139 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 445 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 3389 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p tcp -m tcp --dport 3050 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p udp --dport 137 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p udp --dport 138 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A PREROUTING -d KMUX_INTERN_SVC_IP -p udp --dport 177 -j DNAT --to-destination KMUX_DUMMY_SVC_IP 
-A OUTPUT -d KMUX_INTERN_SVC_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_SVC_IP 

# fs
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 139 -j DNAT --to-destination KMUX_DUMMY_FS_IP 
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 445 -j DNAT --to-destination KMUX_DUMMY_FS_IP 
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_FS_IP 
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 5051 -j DNAT --to-destination KMUX_DUMMY_FS_IP
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 5405 -j DNAT --to-destination KMUX_DUMMY_FS_IP
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp -m tcp --dport 5105 -j DNAT --to-destination KMUX_DUMMY_FS_IP 
-A PREROUTING -d KMUX_INTERN_FS_IP -p udp --dport 137 -j DNAT --to-destination KMUX_DUMMY_FS_IP 
-A PREROUTING -d KMUX_INTERN_FS_IP -p udp --dport 138 -j DNAT --to-destination KMUX_DUMMY_FS_IP
-A PREROUTING -d KMUX_INTERN_FS_IP -p tcp --dport 10809 -j DNAT --to-destination KMUX_DUMMY_FS_IP
-A OUTPUT -d KMUX_INTERN_FS_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_FS_IP
-A OUTPUT -d KMUX_INTERN_FS_IP -p udp -j DNAT --to-destination KMUX_DUMMY_FS_IP 

-A PREROUTING -d KMUX_INTERN_ARCH_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_ARCH_IP 
-A PREROUTING -d KMUX_INTERN_ARCH_IP -p udp --dport 177 -j DNAT --to-destination KMUX_DUMMY_ARCH_IP 
-A OUTPUT -d KMUX_INTERN_ARCH_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ARCH_IP 

-A PREROUTING -d KMUX_INTERN_OSCOMM_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_OSCOMM_IP 
-A OUTPUT -d KMUX_INTERN_OSCOMM_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_OSCOMM_IP 

-A PREROUTING -d KMUX_INTERN_EGROUPWARE_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_EGROUPWARE_IP 
-A OUTPUT -d KMUX_INTERN_EGROUPWARE_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_EGROUPWARE_IP 

# Adempiere braucht noch mehr Ports, daher erst mal alles durchleiten
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 4444 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 4445 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 8009 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 8083 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 1098 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 1099 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 5432 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 1389 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP
-A PREROUTING -d KMUX_INTERN_ADEMPIERE_IP -p tcp -m tcp --dport 3873 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP
-A OUTPUT -d KMUX_INTERN_ADEMPIERE_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE_IP 


# Adempiere2 braucht noch mehr Ports, daher erst mal alles durchleiten
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 4444 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 4445 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 8009 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 8083 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 1098 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 1099 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 5432 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 1389 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP
-A PREROUTING -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP
-A OUTPUT -d KMUX_INTERN_ADEMPIERE2_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE2_IP 

# Adempiere3 braucht noch mehr Ports, daher erst mal alles durchleiten
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 4444 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 4445 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 8009 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 8083 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 1098 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 1099 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 5432 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 1389 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP
-A PREROUTING -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP
-A OUTPUT -d KMUX_INTERN_ADEMPIERE3_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_ADEMPIERE3_IP 

# Asterisk Services
-A PREROUTING -d KMUX_INTERN_ASTERISK_IP -p tcp -m tcp -j DNAT --to-destination KMUX_DUMMY_ASTERISK_IP 
-A PREROUTING -d KMUX_INTERN_ASTERISK_IP -p udp -j DNAT --to-destination KMUX_DUMMY_ASTERISK_IP
-A OUTPUT -p tcp --destination KMUX_INTERN_ASTERISK_IP -j DNAT --to-destination KMUX_DUMMY_ASTERISK_IP
-A OUTPUT -p udp --destination KMUX_INTERN_ASTERISK_IP -j DNAT --to-destination KMUX_DUMMY_ASTERISK_IP

# Averp
#-A PREROUTING -d KMUX_INTERN_AVERP_IP -p tcp -m tcp --dport 3050 -j DNAT --to-destination KMUX_DUMMY_AVERP_IP
-A PREROUTING -d KMUX_INTERN_AVERP_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_AVERP_IP
-A PREROUTING -d KMUX_INTERN_AVERP_IP -p tcp -m tcp --dport 22 -j DNAT --to-destination KMUX_DUMMY_AVERP_IP
-A OUTPUT -d KMUX_INTERN_AVERP_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_AVERP_IP 

# Tryton
-A PREROUTING -d KMUX_INTERN_TRYTON_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_TRYTON_IP
-A PREROUTING -d KMUX_INTERN_TRYTON_IP -p tcp -m tcp --dport 2813 -j DNAT --to-destination KMUX_DUMMY_TRYTON_IP
-A PREROUTING -d KMUX_INTERN_TRYTON_IP -p tcp -m tcp --dport 8070 -j DNAT --to-destination KMUX_DUMMY_TRYTON_IP
-A OUTPUT -d KMUX_INTERN_TRYTON_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_TRYTON_IP 

# Scalable OpenGroupware
#-A PREROUTING -d KMUX_INTERN_SOGO_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_SOGO_IP
#-A PREROUTING -d KMUX_INTERN_SOGO_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_SOGO_IP
#-A PREROUTING -d KMUX_INTERN_SOGO_IP -p tcp -m tcp --dport 20000 -j DNAT --to-destination KMUX_DUMMY_SOGO_IP
#-A OUTPUT -d KMUX_INTERN_SOGO_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_SOGO_IP 

# Scalable OpenGroupware 2
-A PREROUTING -d KMUX_INTERN_SOGO2_IP -p tcp -m tcp --dport 80 -j DNAT --to-destination KMUX_DUMMY_SOGO2_IP
-A PREROUTING -d KMUX_INTERN_SOGO2_IP -p tcp -m tcp --dport 443 -j DNAT --to-destination KMUX_DUMMY_SOGO2_IP
-A PREROUTING -d KMUX_INTERN_SOGO2_IP -p tcp -m tcp --dport 20000 -j DNAT --to-destination KMUX_DUMMY_SOGO2_IP
-A OUTPUT -d KMUX_INTERN_SOGO2_IP -p tcp -j DNAT --to-destination KMUX_DUMMY_SOGO2_IP 

# transparent web proxy
# all local traffic except from the squid-proxy itself redirect to proxy
# no proxy for user-root (needed for installation: 
# if we redirect the root-originated traffic, the installation stops for unknown reason ...)
#-A OUTPUT -p tcp -m owner ! --uid-owner proxy -m owner ! --uid-owner root --dport 80 -j REDIRECT --to-port 3128
# sind in den sources.list file die Quellen NICHT mehrfach vorhanden, so geht es dann ...
-A OUTPUT -p tcp -m owner ! --uid-owner proxy  --dport 80 -j REDIRECT --to-port 3128

# all traffic from internal to external web
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_NETIP/KMUX_INTERN_NETMASK_BITS --dport 80 -j REDIRECT --to-port 3128
-A PREROUTING -i KMUX_VPN_INTERFACE -p tcp ! -d KMUX_INTERN_NETIP/KMUX_INTERN_NETMASK_BITS --dport 80 -j REDIRECT --to-port 3128

# ftp proxy
# all ftp traffic from internal to external ftp through ftp-proxy
#-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_MAIL_IP --dport 21 -j REDIRECT --to-port 2121
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_MAIL_IP --dport 21 -j ACCEPT

# ntp redirect to local ntp-server
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_HOST_IP --dport 123 -j DNAT --to-destination KMUX_INTERN_HOST_IP
-A PREROUTING -i KMUX_INTERN_INTERFACE -p udp ! -d KMUX_INTERN_HOST_IP --dport 123 -j DNAT --to-destination KMUX_INTERN_HOST_IP

# dns redirect to local dns-server
-A PREROUTING -i KMUX_INTERN_INTERFACE -p tcp ! -d KMUX_INTERN_HOST_IP --dport 53 -j DNAT --to-destination KMUX_INTERN_HOST_IP
-A PREROUTING -i KMUX_INTERN_INTERFACE -p udp ! -d KMUX_INTERN_HOST_IP --dport 53 -j DNAT --to-destination KMUX_INTERN_HOST_IP

# output rules to route to SNAT from the vservers to the intern network

-A POSTROUTING -s KMUX_DUMMY_SVC_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SVC_IP
-A POSTROUTING -s KMUX_DUMMY_FS_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FS_IP

# for a vpn connection
-A POSTROUTING -s KMUX_DUMMY_SVC_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SVC_IP
-A POSTROUTING -s KMUX_DUMMY_FS_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FS_IP
-A POSTROUTING -s KMUX_DUMMY_MAIL_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_MAIL_IP
-A POSTROUTING -s KMUX_DUMMY_LDAP_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_LDAP_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE2_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE2_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE3_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE3_IP
-A POSTROUTING -s KMUX_DUMMY_AVERP_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_AVERP_IP
-A POSTROUTING -s KMUX_DUMMY_CUSTOM_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_CUSTOM_IP
-A POSTROUTING -s KMUX_DUMMY_AGFEO_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_AGFEO_IP
-A POSTROUTING -s KMUX_DUMMY_SUGAR_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SUGAR_IP
-A POSTROUTING -s KMUX_DUMMY_ZPUB_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ZPUB_IP
-A POSTROUTING -s KMUX_DUMMY_WORDPRESS_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_WORDPRESS_IP
-A POSTROUTING -s KMUX_DUMMY_FIND_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FIND_IP
-A POSTROUTING -s KMUX_DUMMY_IMIXS_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_IMIXS_IP
-A POSTROUTING -s KMUX_DUMMY_TRYTON_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_TRYTON_IP
#-A POSTROUTING -s KMUX_DUMMY_SOGO_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SOGO_IP
-A POSTROUTING -s KMUX_DUMMY_SOGO2_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SOGO2_IP
-A POSTROUTING -s KMUX_DUMMY_FRIENDICA_IP -d KMUX_VPN_NETWORK/KMUX_VPN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FRIENDICA_IP

-A POSTROUTING -s KMUX_DUMMY_MAIL_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_MAIL_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE_IP
-A POSTROUTING -s KMUX_DUMMY_ASTERISK_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ASTERISK_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE2_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE2_IP
-A POSTROUTING -s KMUX_DUMMY_ADEMPIERE3_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ADEMPIERE3_IP
-A POSTROUTING -s KMUX_DUMMY_AVERP_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_AVERP_IP
-A POSTROUTING -s KMUX_DUMMY_CUSTOM_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_CUSTOM_IP
-A POSTROUTING -s KMUX_DUMMY_AGFEO_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_AGFEO_IP
-A POSTROUTING -s KMUX_DUMMY_SUGAR_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SUGAR_IP
-A POSTROUTING -s KMUX_DUMMY_ZPUB_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_ZPUB_IP
-A POSTROUTING -s KMUX_DUMMY_WORDPRESS_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_WORDPRESS_IP
-A POSTROUTING -s KMUX_DUMMY_FIND_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FIND_IP
-A POSTROUTING -s KMUX_DUMMY_IMIXS_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_IMIXS_IP
-A POSTROUTING -s KMUX_DUMMY_TRYTON_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_TRYTON_IP
#-A POSTROUTING -s KMUX_DUMMY_SOGO_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SOGO_IP
-A POSTROUTING -s KMUX_DUMMY_SOGO2_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_SOGO2_IP
-A POSTROUTING -s KMUX_DUMMY_FRIENDICA_IP -d KMUX_INTERN_NETWORK/KMUX_INTERN_NETMASK_BITS -j SNAT --to-source KMUX_INTERN_FRIENDICA_IP

# iptables testing (uses monit service itself)
# geht so nicht???
#-A OUTPUT -d KMUX_INTERN_HOST_IP -p tcp --dport 2814 -j REDIRECT --to-port 2813 

-A POSTROUTING -o KMUX_EXTERN_INTERFACE -j MASQUERADE 

COMMIT
